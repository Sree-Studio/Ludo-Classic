<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ludo Game</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #1e1e2f;
            color: white;
            text-align: center;
        }

        #menu, #game, #leaderboard {
            padding: 20px;
        }

        /* Initial state: Only menu is visible */
        #game, #leaderboard, .hidden {
            display: none;
        }

        button {
            padding: 12px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            background: #444;
            color: white;
            border: none;
            border-radius: 5px;
        }

        button:hover { background: #666; }

        #dice {
            width: 80px;
            height: 80px;
            background: white;
            color: black;
            font-size: 40px;
            line-height: 80px;
            margin: 20px auto;
            border-radius: 10px;
        }

        #board-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(13, 40px);
            grid-template-rows: repeat(13, 40px);
            gap: 2px;
            background: #222;
            padding: 5px;
        }

        .cell {
            width: 40px;
            height: 40px;
            background: #eee;
            border-radius: 4px;
            position: relative;
        }

        .safe { background: #cfd8dc; border: 2px solid gold; }

        .token {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            border: 2px solid black;
            z-index: 10;
        }

        .token.red { background: red; }
        .token.green { background: green; }
        .token.blue { background: blue; }
        .token.yellow { background: gold; }

        #winScreen {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
    </style>
</head>
<body>

<div style="margin:10px;">
    <label>
        <input type="checkbox" id="soundToggle" checked> Sound
    </label>
    <button onclick="toggleFullscreen()">üî≥ Fullscreen</button>
    <button onclick="location.reload()">Restart</button>
</div>

<h1>üé≤ LUDO GAME üé≤</h1>

<div id="menu">
    <h2>Select Mode</h2>
    <button onclick="startGame(1)">Single Player (vs 3 AI)</button>
    <button onclick="startGame(2)">2 Player</button>
    <button onclick="startGame(4)">4 Player</button>
</div>

<div id="game">
    <h2 id="turnText">Turn: RED</h2>
    <div id="dice">üé≤</div>
    <button onclick="rollDice()">Roll Dice</button>

    <div id="board-container">
        <div id="board"></div>
    </div>
</div>

<div id="winScreen" class="hidden">
    <h1>üèÜ Match Finished</h1>
    <ol id="finalLeaderboard"></ol>
    <button onclick="location.reload()">Play Again</button>
</div>

<audio id="diceSound" src=""></audio>
<audio id="moveSound" src=""></audio>
<audio id="winSound" src=""></audio>

<script>
/* ---------- INITIALIZATION ---------- */
let settings = {
    sound: true,
    players: 4,
    aiPlayers: []
};

let players = [];
let currentPlayer = 0;
let diceValue = 0;
let leaderboard = [];

const SAFE_CELLS = [0, 8, 13, 21, 26, 34, 39, 47];
const COLORS = ["red", "green", "blue", "yellow"];

// This mimics a basic path through a grid. 
// In a real Ludo game, this array would contain all 52+ coordinates.
const BOARD_PATH = [
  44, 45, 46, 47, 48, 56, 69, 82, 95, 108, 121, 134, 147, 148, 149, 136, 123, 110, 97, 84, 71, 70, 68, 67, 66, 65, 52, 39, 26, 13, 0, 1, 2, 15, 28, 41, 54, 67, 80, 81
];

function startGame(count) {
    settings.players = 4; // Ludo usually has 4 slots
    // If single player, set 1, 2, and 3 as AI
    settings.aiPlayers = count === 1 ? [1, 2, 3] : []; 
    
    document.getElementById("menu").style.display = "none";
    document.getElementById("game").style.display = "block";
    
    settings.sound = document.getElementById("soundToggle").checked;
    initGame(4);
}

function initGame(playerCount) {
    players = [];
    leaderboard = [];
    currentPlayer = 0;

    for (let i = 0; i < playerCount; i++) {
        players.push({
            color: COLORS[i],
            pieces: [-1, -1, -1, -1], 
            finished: 0,
            isAI: settings.aiPlayers.includes(i)
        });
    }

    renderBoard();
    updateTurn();
}

/* ---------- CORE LOGIC ---------- */
function rollDice() {
    if (diceValue !== 0) return; 

    diceValue = Math.floor(Math.random() * 6) + 1;
    document.getElementById("dice").innerText = diceValue;
    playSound("diceSound");

    // Check if player has any valid moves
    let hasMove = players[currentPlayer].pieces.some((pos) => isValidMove(pos));

    if (!hasMove) {
        setTimeout(() => {
            diceValue = 0;
            nextTurn();
        }, 1000);
    } else if (players[currentPlayer].isAI) {
        setTimeout(aiMove, 700);
    }
}

function movePiece(pIndex, pieceIndex) {
    if (pIndex !== currentPlayer || diceValue === 0) return;

    let pos = players[pIndex].pieces[pieceIndex];

    if (pos === -1 && diceValue !== 6) return;
    
    if (pos === -1 && diceValue === 6) {
        players[pIndex].pieces[pieceIndex] = 0; // Entry
    } else {
        players[pIndex].pieces[pieceIndex] += diceValue;
    }

    handleCapture(pIndex, pieceIndex);
    checkWin(pIndex, pieceIndex);

    let rolledSix = (diceValue === 6);
    diceValue = 0;

    if (!rolledSix) {
        nextTurn();
    } else {
        updateTurn(); // Allow same player to roll again
    }

    renderBoard();
}

function nextTurn() {
    currentPlayer = (currentPlayer + 1) % players.length;
    if (players[currentPlayer].finished === 4) return nextTurn();

    updateTurn();
    if (players[currentPlayer].isAI) {
        setTimeout(rollDice, 1000);
    }
}

function updateTurn() {
    document.getElementById("turnText").innerText = "Turn: " + players[currentPlayer].color.toUpperCase();
}

/* ---------- UI RENDERING ---------- */
function renderBoard() {
    const board = document.getElementById("board");
    board.innerHTML = "";

    for (let i = 0; i < 169; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        if (SAFE_CELLS.includes(i % 52)) cell.classList.add("safe");
        board.appendChild(cell);
    }
    renderTokens();
}

function renderTokens() {
    const cells = document.querySelectorAll(".cell");
    players.forEach((player, pIndex) => {
        player.pieces.forEach((pos, i) => {
            if (pos === -1) return; // Still at home

            const cellIndex = BOARD_PATH[pos % BOARD_PATH.length];
            const token = document.createElement("div");
            token.className = `token ${player.color}`;
            token.onclick = () => movePiece(pIndex, i);
            cells[cellIndex].appendChild(token);
        });
    });
}

/* ---------- HELPERS ---------- */
function isValidMove(pos) {
    if (pos === -1 && diceValue === 6) return true;
    if (pos >= 0 && pos + diceValue <= 57) return true;
    return false;
}

function handleCapture(pIndex, pieceIndex) {
    let pos = players[pIndex].pieces[pieceIndex];
    if (SAFE_CELLS.includes(pos)) return;

    players.forEach((pl, i) => {
        if (i === pIndex) return;
        pl.pieces.forEach((p, j) => {
            if (p === pos) {
                pl.pieces[j] = -1;
                playSound("moveSound");
            }
        });
    });
}

function checkWin(pIndex, pieceIndex) {
    if (players[pIndex].pieces[pieceIndex] >= 57) {
        players[pIndex].finished++;
        if (players[pIndex].finished === 4) {
            leaderboard.push(players[pIndex].color);
            if (leaderboard.length >= players.length - 1) showWinScreen();
        }
    }
}

function aiMove() {
    let player = players[currentPlayer];
    let possibleMoves = [];

    player.pieces.forEach((pos, index) => {
        if (isValidMove(pos)) possibleMoves.push(index);
    });

    if (possibleMoves.length > 0) {
        let choice = possibleMoves[Math.floor(Math.random() * possibleMoves.length)];
        movePiece(currentPlayer, choice);
    }
}

function playSound(id) {
    if (!settings.sound) return;
    const audio = document.getElementById(id);
    if (audio && audio.src) audio.play().catch(() => {});
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

function showWinScreen() {
    document.getElementById("winScreen").classList.remove("hidden");
    const list = document.getElementById("finalLeaderboard");
    leaderboard.forEach(color => {
        let li = document.createElement("li");
        li.innerText = color.toUpperCase();
        list.appendChild(li);
    });
}
</script>

</body>
</html>
